name: Deploy with Verification & Rollback

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      # ğŸ”¨ Build Docker Image
      - name: Build Docker Image
        run: docker build -t habit-tracker:${{ github.sha }} .

      # ğŸš€ Push Image (example: ECR)
      - name: Push Docker Image
        run: |
          echo "Pushing image to registry..."
          # docker push <ECR_URL>/habit-tracker:${{ github.sha }}

      # ğŸš¢ Deploy (ECS / Azure)
      - name: Deploy Application
        run: |
          echo "Deploying application..."
          # aws ecs update-service ...

      # âœ… VERIFY DEPLOYMENT
      - name: Verify Deployment Health
        run: |
          echo "Verifying deployment..."
          sleep 20
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://your-domain.com/api/health)
          if [ "$STATUS" -ne 200 ]; then
            echo "âŒ Health check failed"
            exit 1
          fi
          echo "âœ… Deployment verified"

      # ğŸ” ROLLBACK ON FAILURE
      - name: Rollback Deployment
        if: failure()
        run: |
          echo "âš ï¸ Rolling back to previous stable version..."
          # aws ecs update-service --force-new-deployment --task-definition previous
